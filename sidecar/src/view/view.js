(function(app) {

    /**
     * Base View class. Use {@link View.LayoutManager} to create instances of views.
     *
     * @class View.View
     * @alias SUGAR.App.layout.View
     */
    app.layout.View = Backbone.View.extend({
        initialize: function(options) {
            _.bindAll(this, 'render', 'bindData');

            /**
             * The context is used to determine what the current focus is
             * (includes a model, collection, and module)
             * @cfg {Core.Context}
             */
            this.context = options.context || app.controller.context;

            /**
             * Name of the View
             * @cfg {String}
             */
            this.name = options.name;

            /**
             * Id of the View. Autogenerated if not specified.
             * @cfg {String}
             * @type {String}
             */
            this.id = options.id || this.getID();

            /**
             * Classname of the root div. Uses name if none is provided.
             * @cfg {String} className
             */
            this.$el.addClass("view " + (options.className || this.name));

            /**
             * Template to render
             * @cfg {Template}
             */
            this.template = options.template || app.template.get(this.name, this.context.get("module"));

            /**
             * Metadata
             * @cfg {Object}
             */
            this.meta = options.meta;
            this.sugarFields = {};
        },

        /**
         * Bind render to data
         * @method
         * @param {Object} data Model or collection to bind to
         */
        bindData: function(data) {
            data.on('reset', this.render);
        },

        /**
         * Bind this view to listen to the given context's event.
         * @param {Core.Context} context
         */
        bind: function(context) {

        },

        /**
         * Renders the view onto the page. (should be overriden by subclasses instead of the formal render function if they need more advanced rendering or do not use a template)
         * @protected
         * @method
         */
        _render: function() {
            if (this.template) {
                this.$el.html(this.template(this));
            }
        },

        /**
         * Renders the view onto the page. See Backbone.View
         * @return {Object} this
         */
        render: function() {
            //Bad templates can cause a JS error that we want to catch here
            try {
                this._render();
                //Render will create a placeholder for sugar fields. we now need to populate those fields
                _.each(this.sugarFields, function(sf) {
                    sf.setElement(this.$el.find("span[sfuuid='" + sf.sfid + "']"));
                    sf.render();
                }, this);
            } catch (e) {
                app.logger.error("Runtime template error in " + this.name + ".\n" + e.message);
            }

            return this;
        },

        /**
         * Extracts the fields from the metadata for directly related views/panels
         * TODO: Possibly refactor
         * @return {Array} List of fields used on this view
         */
        getFields: function() {
            var fields = [];
            if (this.meta && this.meta.panels) {
                _.each(this.meta.panels, function(panel) {
                    fields = fields.concat(_.pluck(panel.fields, 'name'));
                });
            }

            return _.filter(_.uniq(fields), function(value) {
                return value;
            });
        },

        /**
         * Returns the html id of this view's el. Will create one if one doesn't exist.
         * @return {String} id of this view.
         */
        getID: function() {
            return this.id || this.context.get("module") + "_" + this.options.name;
        }
    });


})(SUGAR.App);