<div class="drawer-tab">
  <a href="#" title="Expand list pane" class="btn"><i class="icon-chevron-up"></i></a>
</div>

<script>
  $(document).ready(function() {
    $('#content').append('<div class="drawer-backdrop"></div>');
    // expand edit row
    $('.drawer-tab .btn').off('click').on('click', function (e) {
      $(this).find('i').toggleClass('icon-chevron-up').toggleClass('icon-chevron-down');
      $('.drawer').toggleClass('expand');
      $('.drawer-squeezed').toggleClass('collapse');
      e.preventDefault();
    });
  });

var empty_modal_template = '\
      <div class="main-pane span8" id="edit">\
        <div class="headerpane ellipsis">\
          <div class="btn-toolbar pull-right dropdown">\
            <a class="btn btn-invisible btn-link cancel">Cancel</a>\
            <a class="btn btn-primary disabled save">Save</a>\
            <a href="#overview" title="Collapse sidebar" class="btn btn-invisible drawerTrig"><i class="icon-double-angle-right"></i></a>\
          </div>\
          <h1>~TITLE~</h1>\
        </div>\
        <div class="record">\
           ~CONTENT~\
        </div>\
        <div class="main-content"></div>\
      </div>\
      <div class="side sidebar-content span4">\
        <div class="side-pane active" id="overview-edit">\
          <div class="howto">\
            <h3>~TITLE2~</h3>\
            <p>~CONTENT2~</p>\
          </div>\
        </div>\
        <div class="preview-pane" id="preview-edit"></div>\
      </div>\
';


  function drawer(show) {
      $('.module-edit').toggleClass('drawer',show);
      $('.module-view').toggleClass('drawer-squeezed',show);
      $('.drawer-backdrop').toggleClass('drawer-squeezed',show);
      $('.drawer').addClass('expand');
      $('.drawer-squeezed').addClass('collapse');
      if (!show) {
        //$('.drawer-tab .btn').find('i').removeClass('icon-chevron-up').addClass('icon-chevron-down');
        $('.drawer').removeClass('expand');
        $('.drawer-squeezed').removeClass('collapse');
        $('.drawer-backdrop').removeClass('collapse');
        $('.module-edit').removeClass('expand');
        $('.module-view').removeClass('collapse');
      } else {
        $('.module-edit').addClass('modalX').attr('id','module-edit-index-0').find('.record').html('modal number 0');
        populate_modal('#module-edit-index-0', empty_modal_template, 0);
      }
  }

  function populate_modal(el,tpl,i) {
    var tpl = tpl
        .replace("~TITLE~","Modal No. " + i)
        .replace("~CONTENT~","This is content of the modal number " + i)
        .replace("~TITLE2~", "Sidebar of " + i + " modal")
        .replace("~CONTENT2~", "Some content here.");
    $(el).html(tpl);
    console.log(el);
  }

  function stack_modal(action) {
    if($('.modalX').length === 0) {
      drawer(true);
      return false;
    }
    //var modal_selector = $('.module-edit.drawer'),
    var modal_selector = $('.module-edit.drawer'),
        modalX_selector = $('.modalX'),
        content_container = $('#content'),
        drawer_backdrop = $('.drawer-backdrop');
    if(action == 'remove') {
      var update_modal_count = $('.modalX').length;
      if(update_modal_count > 1) {
        modalX_selector.last().remove();
        $('.modalX:eq('+(update_modal_count-2)+')').attr('class','row-fluid module-edit drawer expand modalX VISIBLE');
      } else {
        drawer(false); // close drawer if last modal was removed
      }
    } else {
      var modal_count = $('.modalX').length,
          modal_last_visible = $('.module-edit.drawer:last'),
          modal_count_i = modal_count === 1 ? 1 : modal_count ++;
      modal_selector.first()
        .clone()
        .attr({
          'id': 'module-edit-index-' + modal_count_i,
        })
        .insertBefore(drawer_backdrop)
        .addClass('VISIBLE');
        //.find('.record').html('modal number ' + modal_count_i);
      populate_modal($('#module-edit-index-' + modal_count_i), empty_modal_template , modal_count_i);
      modal_last_visible.attr('class','row-fluid module-view drawer-squeezed collapse modalX');
    }
  }






</script>