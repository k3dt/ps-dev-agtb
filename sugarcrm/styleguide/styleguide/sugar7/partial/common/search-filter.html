<!-- synced dom with sidecar on 11/21/2112 -->
<form class="form-search" action="" id="{{sourceid}}">
    <div class="row-fluid control-group">
        <div class="filter controls controls-four btn-fit">
            <div class="search">
                <select id="search_filter" class="chzn-select search" multiple data-placeholder=" ">
                </select>
            </div>
            <div class="actions" data-toggle="buttons-radio">
                <a href="{{module}}/{{module}}-activitystream.html" class="btn btn-invisible btn-dark fourth" data-view="activitystream" data-toggle="proto" data-target="#view .main-content" data-mode="view" rel="tooltip" data-original-title="Activity stream"><i class="icon-th-list"></i></a>
                <a href="#" class="btn btn-invisible btn-dark third" data-view="timeline" data-mode="view" rel="tooltip" data-original-title="Timeline"><i class="icon-time"></i></a>
                <a href="#" class="btn btn-invisible btn-dark second" data-view="calendar" data-mode="view" rel="tooltip" data-original-title="Calendar"><i class="icon-calendar"></i></a>
                <a href="common/data-table.html" class="btn btn-invisible btn-dark first" data-view="list" data-toggle="proto" data-target="#view .main-content" data-mode="view" rel="tooltip" data-original-title="List"><i class="icon-table"></i></a>
            </div>
        </div>
    </div>

    <div class="filter-options extend hide">
        <article class="filter-header">
            <div class="row-fluid">
                <div class="controls span6">
                    <input name="filter" type="text" value="" class="inherit-width" placeholder="Enter new filter name...">
                    <input name="id" type="hidden" value="">
                </div>
                <div class="span6">
                    <div class="pull-right">
                        <a href="#delete" class="btn btn-link btn-invisible hide">Delete</a>
                        <a href="#save" class="btn btn-primary disabled">Save</a>
                        <a href="#" class="filter-close btn btn-invisible btn-dark"><i class="icon-remove"></i></a>
                    </div>
                </div>
            </div>
        </article>
        <article class="filter-body">
          <div class="row-fluid">
            <div class="controls span3">
                <input type="text" value="Module" disabled="disabled" class="disabled inherit-width">
            </div>
            <div class="controls span3">
                <input type="text" value="{{title}}" disabled="disabled" class="disabled inherit-width">
            </div>
            <div class="filter-value controls span6">
            </div>
          </div>
        </article>
    </div>
    <div class="mu extend hide">
        <article class="filter-header">
            <strong>
                Mass Update
            </strong>
            <div class="pull-right">
                <a href="#" class="btn btn-primary">Update</a>
                <a href="#" class="btn btn-invisible"><i class="icon-remove"></i></a>
            </div>
        </article>
        <article class="filter-body">
            <div class="row-fluid">
                <div class="controls span3">
                    <select name="field" class="chzn-select chzn-inherit-width buildit">
                        <option data-values="matches,contains,not matches,not contains" data-text="true" data-enabled="true">Name</option>
                        <option data-values="matches" data-text="true" data-enabled="false">Assigned to</option>
                        <option data-values="prospecting,value proposition,closed won,closed lost" data-text="false" data-enabled="true">Sales Stage</option>
                        <option data-values="true" data-text="false" data-enabled="false">Favorite</option>
                    </select>
                </div>
                <div class="controls span3">
                    <select name="opera" class="chzn-select chzn-inherit-width">
                        <option>matches</option>
                        <option>contains</option>
                        <option>not matches</option>
                        <option>not matches</option>
                    </select>
                </div>
                <div class="filter-value controls span6">
                    <input name="value" type="text" class="inherit-width" placeholder="Enter a name...">
                    <a href="" class="btn btn-invisible addme"><i class="icon-plus"></i></a>
                </div>
            </div>
        </article>
    </div>
</form>

<script>
  var availableFilters = [
    {"label":"My Favorites", "id":"filter_1", "disabled":false, "selected":false, "classes":"", "spec":[
      {'field':'favorite','opera':'true'}
    ]},
    {"label":"My {{title}}", "id":"filter_2", "disabled":false, "selected":false, "classes":"", "spec":[
      {'field':'assigned','opera':'matches','value':'westin'}
    ]},
    {"label":"My Custom Filter", "id":"filter_3", "disabled":false, "selected":false, "classes":"", "spec":[
      {'field':'assigned','opera':'matches','value':'westin'},
      {'field':'stage','opera':'closed won'},
      {'field':'created','opera':'Last 7 days'}
    ]},
    {"label":"Create New Filter", "id":"filter_new", "disabled":false, "selected":false, "classes":"primary filter-new", "spec":[]}
  ];
  // add the current module as default chosen filter
  if ( window.location.pathname.split('/').pop() !== 'dashboard.html') {
      availableFilters.unshift(
          {"label":"{{title}}", "id":"filter_module", "disabled":true, "selected":true, "classes":"filter-disabled", "spec":[]}
      );
  }
  var filterFields = {
    'default': {'label':'','opera':'','value':'','disabled':true,'text':false},
    'name': {'label':'Name','opera':'matches,contains,not matches,not contains,true,false','disabled':false,'text':true},
    'assigned': {'label':'Assigned to','opera':'matches','disabled':true,'text':true},
    'stage': {'label':'Sales Stage','opera':'prospecting,value proposition,closed won,closed lost','disabled':false,'text':false},
    'favorite': {'label':'Favorite','opera':'true,false','disabled':false,'text':false},
    'created': {'label':'Created','opera':'Last 7 days,Last 30 days,Last 90 days,Last year','disabled':false,'text':false},
  };
//TODO: do we need an apply or does a search happen each time a filter row is added or updated
//TODO: when result is chosen, should we remove filter row choices or keep them and set create filter to use existing filter row choices.
//TODO: remove choice on single backspace
//TODO: prevent adding blank filter row
  $(document).ready(function() {

      // define global elements
      var _form = $('#{{sourceid}}'),
          _select = $('#{{sourceid}} #search_filter'),
          _options = $('#{{sourceid}} .filter-options'),
          _header = $('#{{sourceid}} .filter-header'),
          _choices,
          _results;

      // set up filter result options
      $.each(availableFilters, function(index,value){
          _select.append(
              '<option value="'+ value.id +'"'+
              ' class="custom-choice custom-result '+ (value.classes!==''?value.classes:'') +'"' +
              (value.selected?' selected="selected"':'') +
              (value.disabled?' disabled="disabled"':'') +'>'+
              value.label +
              '</option>'
          );
      });

      // instatiate filter select chosen
      _select.chosen({
        searchResultConstructor: function (id,classes,style,html,index) {
            var rtn = '<li id="'+ id +'" class="'+ classes +'" style="'+ style +'">'+ html +'</li>';
                rtn += (html.indexOf('Create New Filter')===-1) ? '<span class="icon-ok"></span>' : '<span class="icon-plus"></span>';
            return rtn;
        },
        searchChoiceConstructor: searchChoiceConstructor
      });
      _select.trigger("liszt:updated");

      // define global chosen elements
      _choices = $('#{{sourceid}} #search_filter_chzn .chzn-choices');
      _results = $('#{{sourceid}} #search_filter_chzn .chzn-results');

      // prepend legend to .chzn-choices
      _choices.prepend('<legend class="chzn-select-legend">Filter <i class="icon-caret-down"></i></legend>');

      // create new filter
      _results.on('click', '.filter-new', function(e){
          editFilterForm( availableFilters.length-1, true );
          _select.trigger("liszt:close");
          e.preventDefault();
          e.stopPropagation();
      });

      // edit existing filter
      _choices.on('click', 'a', function(e){
          if ( !$(this).parents('li').hasClass('filter-disabled') ) {
              editFilterForm( $(this).attr('rel'), false );
          }
          _select.trigger("liszt:activate");
          _select.trigger("liszt:close");
          e.preventDefault();
          e.stopPropagation();
      });

      // if form changes enable save button
      _form.on('change', function(){
          enableSaveFilterButton();
      });
      _header.find('input[name="filter"]').on('keyup', function(){
          enableSaveFilterButton();
      });

      function editFilterForm (index,isNewFilter) {

          var data = availableFilters[index];

          if (data.classes.indexOf('filter-new')===-1) {
              _results.find('.filter-new').removeClass('result-selected').addClass('active-result');
          }

          _options.find('article[id*="filter_row_"]').remove();
          _header.find('input[name="filter"]').val( data.classes.indexOf('filter-new')>-1?'':data.label );
          _header.find('input[name="id"]').val(data.id);

          // populate filter rows
          $.each(data.spec, function(index,value){
              createFilterRow(index, value, false);
          });

          // add new defalt row
          createFilterRow('new', {'field':'default','opera':'','value':''}, true);
          _header.find('a[href="#delete"]').toggleClass( 'hide', (_header.find('input[name="id"]').val()==='filter_new') );

          // if click save button then update the filter spec
          // and close filter editor
          _header.find('a[href="#save"]').off('click').on('click', function(e){
              if ( !$(this).hasClass('disabled') ) {
                  saveFilter(index,data);
                  _select.trigger("liszt:updated");
                  _results.find('.filter-new').removeClass('result-selected').addClass('active-result');
                  _options.addClass('hide');
              }
              e.preventDefault();
              e.stopPropagation();
          });

          _header.find('a[href="#delete"]').off('click').on('click', function(e){
                removeFilter(index,data);
                _select.trigger("liszt:updated");
                  _options.addClass('hide');
          });

          // close filter option extend
          // and reinstate the filter being edited
          _header.find('.filter-close').off('click').on('click', function(e){
              _select.trigger("liszt:updated");
              _results.find('.filter-new').removeClass('result-selected').addClass('active-result');
              _options.addClass('hide');
              e.preventDefault();
              e.stopPropagation();
          });

          // add filter row
          _options.off('click','.addme').on('click', '.addme', function(e) {
              var row = $(this).parents('.filter-body'),
                  isNewRow = (row.attr('id')==='filter_row_new'?true:false),
                  filterRows = _options.find('article[id*="filter_row_"]');

              if (isNewRow) {
                  row.attr('id', 'filter_row_'+ filterRows.length);
                  enableRemoveFilterRow( row );
                  createFilterRow('new', {'field':'default','opera':'','value':''}, true);
              }
              if (isNewFilter) {
                  createFieldRowChoice( row, _choices, isNewFilter );
              }
              enableSaveFilterButton();
              e.preventDefault();
              e.stopPropagation();
          });

          // remove filter row
          _options.off('click','.removeme').on('click', '.removeme', function(e) {
              var row = $(this).parents('.filter-body'),
                  id = 'search_filter_chzn_f_'+ parseInt(row.attr('id').substr(11),10);
              _choices.find('#'+id).remove();
              row.remove();
              e.preventDefault();
              e.stopPropagation();
          });

          // show edit filter options form
          _options.removeClass('hide');
      }

      function saveFilter (index,data) {

          var title = _header.find('input[type="text"]').val(),
              filterRows = _options.find('article[id*="filter_row_"]'),
              row,
              filter = {};

              filter.label = title;
              filter.id = data.id;
              filter.disabled = false;
              filter.selected = true;
              filter.classes = '';
              filter.spec = [];

          filterRows.each( function(index,value) {
              row = $(value);
              if ( row.attr('id')!=='filter_row_new' ) {
                  filter.spec.push({
                      'field': row.find('select[name="field"]').val(),
                      'opera': row.find('select[name="opera"]').val(),
                      'value': row.find('input[name="value"]').val()
                  });
              }
          });

          // check to see if this is a new filter
          if ( data.id==='filter_new' ) {
              filter.id = 'filter_'+ availableFilters.length;
              var option = '<option value="'+ filter.id +'" selected="selected" class="custom-choice custom-result">'+ title +'</option>';

              // if module filter exists,
              if ( _select.find('option').first().hasClass('filter-disabled') ) {
                  // insert at second else first
                  _select.find('option').first().after( option );
                  availableFilters.splice(1,0,filter);
              } else {
                  // create new result at top
                  _select.prepend( option );
                  availableFilters.unshift(filter);
              }
          } else {
              availableFilters[index] = filter;
              _select.find( 'option[value="'+ data.id +'"]' ).text(title).attr('selected', 'selected');
          }

          // remove field specific filter choices
          _choices.find('li[id*="search_filter_chzn_f_"]').remove();
      }

      function removeFilter (index,data) {
          availableFilters.splice(index,1);
          _select.find( 'option[value="'+ data.id +'"]' ).remove();
      }

      function createFilterRow (index,spec,isNewRow) {

          loadContent('common/search-filter-row.html', '.filter-options', undefined, 'append');

          if (!isNaN(index)) {
              _form.find('#filter_row_new').attr('id','filter_row_'+ index);
          }

          var row = _form.find('#filter_row_'+ index),
              field = row.find('select[name="field"]'),
              opera = row.find('select[name="opera"]'),
              value = row.find('input[name="value"]');

          // enable chosen for filter row
          row.find('.chzn-select').chosen({ disable_search_threshold: 7 });

          setFilterRowInputs( spec, filterFields[spec.field] );

          if (!isNewRow) {
              enableRemoveFilterRow( row );
          }

          field.on('change', function(){
              spec.field = field.val();
              setFilterRowInputs( spec, filterFields[spec.field] );
          });

          function setFilterRowInputs(spec,fieldDef) {

              //set the field
              if (spec.field!=='') {
                field.val(spec.field);
              }
              field.trigger("liszt:updated");

              //set the operations
              opera.find('option').remove();
              $('<option>').appendTo(opera).attr('value','');
              // $.each( fieldDef.opera.split(','), function(index,value){
              //     opera.append('<option value="'+ value +'">'+ value +'</option>');
              // });

              $.each( fieldDef.opera.split(','), function(index,value){
                  $('<option>').appendTo(opera).attr('value', value).text(value);
              });
              //opera.css('display','inline-block');
              //set opera selected to spec value
              if (spec.opera!=='') {
                  opera.val(spec.opera);
              } else if ( fieldDef.disabled==true && fieldDef.opera!=='' ) {
                  opera.val(fieldDef.opera);
              }
              if (spec.opera!=='' || fieldDef.opera!=='') {
                  row.find('#'+opera.attr('id')+'_chzn').show();
              } else {
                  row.find('#'+opera.attr('id')+'_chzn').hide();
              }
              //set opera enabled to field enabled
              if (fieldDef.disabled) {
                  opera.attr('disabled','disabled');
              } else {
                opera.removeAttr('disabled');
              }
              opera.trigger("liszt:updated");

              // hide text input if spect text is false
              value.css('display', (fieldDef.text?'inline-block':'none'));

              // set text input value if spec value is not empty
              value.val(spec.value);
          }
      }

      function enableRemoveFilterRow (filterRow) {
          filterRow.find('.addme').after(
            '<a href="#" class="removeme btn btn-invisible btn-dark"><i class="icon-minus"></i></a>'
          );
      }

      function enableSaveFilterButton () {
          _header.find('a[href="#save"]').toggleClass( 'disabled', _header.find('input[name="filter"]').val()==='' );
      }

      function createFieldRowChoice (filterRow,choices) {
          var id = 'search_filter_chzn_f_'+ parseInt(filterRow.attr('id').substr(11),10),
              field = filterRow.find('select[name="field"] option:selected').text(),
              opera = filterRow.find('select[name="opera"]').val(),
              html = filterRow.find('input[name="value"]').val(),
              index = 99;

          if (html ==='') {
              html = opera;
          }

          if (_choices.find('#'+id).length ) {
              _choices.find('#'+id).find('a').text(html);
              return false;
          } else {
              $('#{{sourceid}} #search_filter_chzn .search-field').before(
                  searchChoiceConstructor(id, {html:html,array_index:index,classes:'search-choice-field'}, field )
              );
              return true;
          }
      }

      function searchChoiceConstructor (id,item,type) {
          if (typeof type==='undefined') {
            type = item.classes.indexOf('filter-disabled')!==-1 ? 'Module' : 'Filter';
          }
          return item.classes.indexOf('filter-new')===-1 ? '<li class="search-choice search-choice-option '+ item.classes +'" id="'+ id +'"><span>'+ type +'</span><a href="javascript:void(0)" rel="'+ item.array_index +'">'+ item.html +'</a></li>' : '';
      }
  });

</script>
