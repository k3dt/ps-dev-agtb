<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>Org Chart</title>
    <link href="../css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="../css/sugar.css" rel="stylesheet" type="text/css">
    <script src="../../assets/js/nvd3/lib/d3.v2.min.js"></script>
    <script src="../../assets/js/nvd3/nv.d3.min.js"></script>
    <script src="../js/nvd3/src/utils.js"></script>
    <style type="text/css">
      body {
        background: url(../img/texture-noise.png);
        overflow: hidden;
        font-size: 14px;
        font-family: "Helvetica Neue", Helvetica;
      }
      #org {
        border: 1px solid black;
        position: absolute;
        left: 20px;
        right: 20px;
        top: 20px;
        bottom: 20px;
      }
      .nv-card {
        fill: #e6e6e6;
        stroke: #999;
        stroke-width: 1px;
        -moz-box-shadow: -5px -5px 5px #888;
        -webkit-box-shadow: -5px -5px 5px #888;
        box-shadow: -5px -5px 5px #888;
      }
      .nv-card circle {
        cursor: pointer;
        /*stroke: steelblue;*/
        stroke-width: 0;
      }
      .nv-card text {
        stroke: none;
      }
      .nv-card line {
        stroke-width: 2;
      }
      .nv-card text.nv-cardName  {
        fill: steelblue;
      }
      .nv-card text.nv-cardTitle  {
        fill: black;
      }
      path.link {
        fill: none;
        stroke: #ccc;
        stroke-width: 1.5px;
      }
    </style>
  </head>
  <body>
    <div id="org"></div>

    <script type="text/javascript">

SimpleGraph = function(elemid, options) {
  var self = this;

  this.container = d3.select(elemid).node();

  this.options = options || {};
  this.options.r = options.r || 5.5;
  this.options.duration = options.duration || 700;
  this.options.padding = options.padding || { top:0, right: 0, bottom:0, left: 0 };

  this.size = {
    "width":  this.container.clientWidth - this.options.padding.left - this.options.padding.right,
    "height": this.container.clientHeight - this.options.padding.top  - this.options.padding.bottom
  };

  this.root = {};



  this.diagonal = d3.svg.diagonal();

  this.svg = d3.select(this.container).append("svg:svg")
    .append("g")
      .attr("transform", "translate(" + 0 + "," + 0 + ")")
      .call(d3.behavior.zoom().scaleExtent([.25, 4]).on("zoom", function () {
        self.chart.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
      }));

  this.svg.append('svg:rect')
    .attr("width", this.size.width)
    .attr("height", this.size.height)
    .style("fill", "transparent");

  this.chart = this.svg.append('g')
    .attr("transform", "translate(" + 0 + "," + 0 + ")");

  this.vis = this.chart.append('g')
    .attr("id","vis")
    .attr("transform", "translate(" + 0 + "," + 40 + ")")
    //.attr("width", 1000);

  this.defs = this.svg.append('defs');
  this.dropShadow = nv.uti

  this.load_data();

  this.bbox = false;
  this.bbox_padding = { w:16, h:10 };

  nv.utils.windowResize(winresize(this));

  function winresize(context) {
    var self = context;

    return function() {
      self.size = {
        "width":  self.container.clientWidth - self.options.padding.left - self.options.padding.right,
        "height": self.container.clientHeight - self.options.padding.top  - self.options.padding.bottom
      };
      self.update();
    }
  }

};



SimpleGraph.prototype.update = function(source) {
  var self = this;

  // Compute the new tree layout.

  var tree = d3.layout.tree()
        //.size([this.size.width,this.size.height])
        //.size([3000,500])
        .size(null)
        .elementsize([this.bbox||110,1])
        .separation( function separation(a,b) {
          //console.log(a)
          return a.parent == b.parent ? 1 : 1;
        });

  var nodes = tree.nodes(self.root);

  var chartwidth = d3.min(nodes,function(d){return d.x}) + d3.max(nodes,function(d){return d.x});
  if ( self.width < chartwidth) {
    //self.vis.attr("transform", "scale("+self.width/chartwidth+")");
    console.log(self.width);
    console.log(chartwidth)
  }
  //nodes = nodes.sort(function(a, b) { return (a.x+((6-a.depth)*10000)) - (b.x+((6-b.depth)*10000)); });

  nodes.forEach(function(d) {
    d.y = d.depth * 100;
  });

  // Update the nodesâ€¦
  var node = self.vis.selectAll("g.nv-card")
      .data(nodes, function (d) {
        return d.id;
      });

  // Enter any new nodes at the parent's previous position.
  var nodeEnter = node.enter().append("svg:g")
      .attr("class", "nv-card")
      .attr("id",function(d){return "nv-card-"+d.id})
      // .attr("transform", function(d) {
      //   return "translate(" + source.x0 + "," + source.y0 + ")scale(.5)";
      // })
      .on("click", function(d) {
        toggle(d);
        self.update(d);
      });

  // node content
  nodeEnter
    .append("image")
      .attr('class', 'nv-cardAvatar')
      .attr("xlink:href", function(d){return "../img/" + d.image})
      .attr("x", -54)
      .attr("y", -30)
      .attr("width", 32)
      .attr("height", 32)
      .style('opacity', 1e-6);
  nodeEnter
    .append('svg:text')
      .attr('class', 'nv-cardName')
      .attr('x', -18)
      .attr('y', -18)
      .attr('text-anchor', 'start')
      .text(function(d){return d.name})
      .style('fill-opacity', 1e-6)
      .style('font-size', 0.7+'em');
  nodeEnter
    .append('svg:text')
      .attr('class', 'nv-cardTitle')
      .attr('x', -18)
      .attr('y', -4)
      .attr('text-anchor', 'start')
      .text(function(d){return d.title})
      .style('fill-opacity', 1e-6)
      .style('font-size', 0.5+'em');

  // background box
  nodeEnter
    .insert('svg:path','.nv-cardAvatar')
      .attr('class', 'nv-cardBox')
      .attr("d", function(d) {
        if (!self.bbox) {
          self.bbox = nodeEnter.node().getBBox();
        }
        //(x, y, width, height, radius)
        console.log(self.bbox_padding)
        return nv.utils.roundedRectangle(
          -((self.bbox.width+16)/2), -(self.bbox.height+2), self.bbox.width+self.bbox_padding.w, self.bbox.height+self.bbox_padding.h, 3
        )
      })
      .style('stroke-opacity', 1e-6)
      .style('fill-opacity', 1e-6)
      .style('filter',self.dropShadow);

  // node control
  var xcCircle = nodeEnter
        .append('svg:g').attr('class','nv-expcoll')
          .attr('transform', 'translate(0,'+ ( self.options.r + 0.5 ) +')');
      xcCircle
        .append("svg:circle").attr('class','nv-circ-back')
          .attr("r",1e-6);
      xcCircle
        .append("svg:line").attr('class','nv-line-vert')
          .attr('x1',0).attr('y1',-(self.options.r-.5)).attr('x2',0).attr('y2',(self.options.r-.5))
          .style('stroke-opacity', 1e-6);
      xcCircle
        .append("svg:line").attr('class','nv-line-hrzn')
          .attr('x1',-(self.options.r-.5)).attr('y1',0).attr('x2',(self.options.r-.5)).attr('y2',0)
          .style('stroke-opacity', 1e-6);

  //Transition nodes to their new position.
  var nodeUpdate = node.transition()
          .duration(self.options.duration)
          .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
      nodeUpdate.select(".nv-circ-back")
          .attr("r", self.options.r)
          .style("stroke-opacity", function(d) { return d.children || d._children ? 1 : 0; })
          .style("fill", function(d) { return d._children ? "#777" : (d.children?'#bbb':"none"); });
      nodeUpdate.select(".nv-circ-frnt")
          .attr("r", self.options.r)
          .style("stroke-opacity", function(d) { return d.children || d._children ? 1 : 0; });
      nodeUpdate.select(".nv-line-vert")
          .style("stroke", function(d) { return d._children ? "#fff" : "none"; })
          .style("stroke-opacity", function(d) { return d._children ? 1 : 0; });
      nodeUpdate.select(".nv-line-hrzn")
          .style("stroke", function(d) { return d.children || d._children ? "#fff" : "none"; })
          .style("stroke-opacity", function(d) { return d.children || d._children ? 1 : 0; });
      nodeUpdate.selectAll("text")
          .style("fill-opacity", 1);
      nodeUpdate.select(".nv-cardBox")
          .style("stroke-opacity", 1)
          .style("fill-opacity", 1);
      nodeUpdate.select(".nv-cardAvatar")
          .style("opacity", 1);


  // Transition exiting nodes to the parent's new position.
  var nodeExit = node.exit().transition()
          .duration(self.options.duration)
          .attr("transform", function(d) { return "translate(" + source.x + "," + source.y + ")"; })
          .remove();
      nodeExit.selectAll("circle")
          .attr("r", 1e-6);
      nodeExit.select(".nv-line-vert")
          .style("stroke-opacity", 1e-6);
      nodeExit.select(".nv-line-hrzn")
          .style("stroke-opacity", 1e-6);
      nodeExit.selectAll("text")
          .style("fill-opacity", 1e-6);
      nodeExit.select(".nv-cardBox")
          .style("stroke-opacity", 1e-6)
          .style("fill-opacity", 1e-6);
      nodeExit.select(".nv-cardAvatar")
          .style("opacity", 1e-6);


  // Update the links
  var link = self.vis.selectAll("path.link")
      .data(tree.links(nodes), function (d) {
        return d.source.id + "-" + d.target.id;
      });

  // Enter any new links at the parent's previous position.
  link.enter().insert("svg:path", "g")
      .attr("class", "link")
      .attr("d", function(d) {
        var o = {x: source.x0, y: source.y0};
        return self.diagonal({source: o, target: o});
      });

  // Transition links to their new position.
  link.transition()
      .duration(self.options.duration)
      .attr("d", self.diagonal);

  // // Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(self.options.duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y};
        return self.diagonal({source: o, target: o});
      })
      .remove();

  // Stash the old positions for transition.
  nodes
    .forEach(function(d) {
      d.x0 = d.x;
      d.y0 = d.y;
    });
// console.log(nodes);

//   var i = 0, l = nodes.length, increase = 0;

//   while( i < l-1 ) {
//       // console.log(nodes[i].x0);
//       // console.log(nodes[i+1].x0)
//     if ( nodes[i].depth === nodes[i+1].depth && nodes[i].x0 + bbox.width+16 > nodes[i+1].x0 )
//     {
//       console.log(nodes[i])
//       console.log(nodes[i+1])

//       increase = nodes[i].x0 + bbox.width+16 - nodes[i+1].x0;
//       break;
//     }
//     i++;
//   }
//   if (increase !== 0){
//     console.log('increase='+increase)
//     self.size.width += increase;
//     increase = 0;
//     self.update();
//   }

  // Toggle children.
  function toggle(d) {
    if (d.children) {
      d._children = d.children;
      d.children = null;
    } else {
      d.children = d._children;
      d._children = null;
    }
  }
};

SimpleGraph.prototype.load_data = function() {
  var self = this;

  d3.json("../js/nvd3/data/tree_data.json", function(json) {
    self.root = json;
    self.root.x0 = 0;
    self.root.y0 = 0;

    function toggleAll(d) {
      if (d.children) {
        d.children.forEach(toggleAll);
        toggle(d);
      }
    }
    // Initialize the display to show a few nodes.
    //root.children.forEach(toggleAll);
    //toggle(root.children[1]);

    self.update(self.root);
  });
};

    </script>

    <script type="text/javascript">
      graph = new SimpleGraph("#org", {
          "xmax": 60, "xmin": 0,
          "ymax": 40, "ymin": 0
        });
    </script>

  </body>
</html>

