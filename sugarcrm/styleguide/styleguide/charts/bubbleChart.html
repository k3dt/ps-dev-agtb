<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=320" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Bubble Chart</title>
  <link href="../css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../css/sugar.css" rel="stylesheet" type="text/css">
  <style>
    #bubble {
      width: 300px;
      height: 500px;
    }
  </style>
</head>
<body class="full-screen">

<div id="bubble" class="nv-chart">
  <svg></svg>
</div>
<script src="../js/jquery-1.7.2.min.js"></script>

<script src="../../assets/js/nvd3/lib/d3.v2.min.js"></script>
<script src="../../assets/js/nvd3/nv.d3.min.js"></script>
<script src="../js/nvd3/data/line_data.js"></script>
<script src="../js/nvd3/src/models/scatter.js"></script>
<script src="../js/nvd3/src/models/bubble.js"></script>
<script src="../js/nvd3/src/models/legend.js"></script>
<script src="../js/nvd3/src/models/bubbleChart.js"></script>

<script>

  // Wrapping in nv.addGraph allows for '0 timeout render', stors rendered charts in nv.graphs, and may do more in the future... it's NOT required
  nv.addGraph(function() {
    var format = d3.time.format("%Y-%m-%d");

    var chart = nv.models.bubbleChart()
          .x(function(d) { return format.parse(d.x) })
          .y(function(d) { return d.y })
          .tooltip( function(key, x, y, e, graph) {
              return '<p>Assigned: <b>' + key + '</b></p>' +
                     '<p>Amount: <b>$' +  d3.format(',.02d')(e.point.opportunity) + '</b></p>' +
                     '<p>Cloase Date: <b>' +  d3.time.format('%x')(format.parse(e.point.x)) + '</b></p>'
            })
          .showTitle(false)
          .tooltips(true)
          .showLegend(true)
          //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: chartData.data.length} )
          //.colorData( 'class' )
          //.colorData( 'default' )
          //.colorFill( 'gradient' )
          //.colorFill( 'default' )
        ;


    d3.json("../js/nvd3/data/top10_opportunities_preprocessed.json", function(json) {
      // console.log(json)
      var bubble_data = {};
          bubble_data.properties = { title: "Top 10 Opportunities", value: json.records.length };
          bubble_data.data = d3.nest()
                        .key(function(d){ return d.assigned_user_name;})
                        .entries(
                          json.records.map(function(d){
                            return {x:d.date_closed, y: parseInt(d.amount,10), shape:'circle', assigned_user_name:d.assigned_user_name };
                          })
                        );
      // console.log(bubble_data)
      // console.log(JSON.stringify(bubble_data, null, '  '))
      //chart.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: bubble_data.data.length} );

      d3.select('#bubble svg')
          .datum(bubble_data)
        .transition().duration(500)
          .call(chart);
    });

    nv.utils.windowResize(chart.update);

    return chart;
  });

// http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities/filter?fields=assigned_user_name%2Cteam_name%2Copportunity_type%2Caccount_name%2Ccampaign_name%2Clead_source%2Ccurrency_name%2Ccurrency_symbol%2Cdate_closed%2Csales_stage%2Csales_status%2Ccommit_stage%2Cassigned_user_id%2Caccount_id%2Ccampaign_id%2Ccurrency_id%2Cname%2Camount%2Cnext_step%2Cprobability%2Ccreated_by_name%2Cmodified_by_name%2Cdate_entered%2Ccreated_by%2Cmodified_user_id&max_num=20&filter%5B0%5D%5B%24owner%5D=
// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities/filter?fields=assigned_user_name%2Cteam_name%2Copportunity_type%2Caccount_name%2Ccampaign_name%2Clead_source%2Ccurrency_name%2Ccurrency_symbol%2Cdate_closed%2Csales_stage%2Csales_status%2Ccommit_stage%2Cassigned_user_id%2Caccount_id%2Ccampaign_id%2Ccurrency_id%2Cname%2Camount%2Cnext_step%2Cprobability%2Ccreated_by_name%2Cmodified_by_name%2Cdate_entered%2Ccreated_by%2Cmodified_user_id&max_num=20&filter%5B0%5D%5B%24owner%5D=';
// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities?fields=name%2Caccount_name%2Camount%2Cassigned_user_name%2Cdate_closed%2Ccurrency_id%2Cbase_rate%2Caccount_id&max_num=10&order_by=amount%3Adesc&my_items=1';

// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities?fields=name%2Caccount_name%2Camount%2Cassigned_user_name%2Cdate_closed%2Ccurrency_id%2Cbase_rate%2Caccount_id&max_num=10&order_by=amount%3Adesc&my_items=1&list=all&limit=0';
</script>
</body>
</html>


