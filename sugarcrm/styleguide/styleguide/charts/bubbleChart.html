<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=320" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Bubble Chart</title>
  <link href="../css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../css/sugar.css" rel="stylesheet" type="text/css">
  <style>
    #bubble {
      width: 700px;
      height: 500px;
    }
  </style>
</head>
<body class="full-screen">

<div id="bubble" class="nv-chart">
  <svg></svg>
</div>
<script src="../js/jquery-1.7.2.min.js"></script>

<script src="../../assets/js/nvd3/lib/d3.v2.min.js"></script>
<script src="../../assets/js/nvd3/nv.d3.min.js"></script>
<script src="../js/nvd3/data/line_data.js"></script>
<script src="../js/nvd3/src/models/scatter_sugar.js"></script>
<script src="../js/nvd3/src/models/bubble.js"></script>
<script src="../js/nvd3/src/models/legend.js"></script>
<script src="../js/nvd3/src/models/bubbleChart.js"></script>

<script>

  // Wrapping in nv.addGraph allows for '0 timeout render', stors rendered charts in nv.graphs, and may do more in the future... it's NOT required
  nv.addGraph(function() {
    var now = new Date(),
        duration = 12,
        startDate = new Date(now.getFullYear(), (duration === 12 ? 0 : Math.ceil((now.getMonth())/3)-1+duration), 1),
        endDate = new Date(now.getFullYear(), (duration === 12 ? 12 : startDate.getMonth()+3), 0),
        dateRange = [startDate,endDate];

    d3.json("../js/nvd3/data/top10_opportunities_preprocessed.json", function(json) {
      // console.log(json)
      var bubble_data = {
            data: json.records
                      .filter(function(d){
                          var oppDate = Date.parse(d.date_closed);
                          return  oppDate >= dateRange[0] && oppDate <= dateRange[1];
                      })
                      .slice(0,10)
                      .map(function(d){
                          return {
                              id: d.id,
                              x: d.date_closed,
                              y: parseInt(d.amount,10),
                              shape: 'circle',
                              account_name: d.account_name,
                              assigned_user_name: d.assigned_user_name,
                              sales_stage: d.sales_stage,
                              probability: d.probability
                          };
                      }),
            properties: { title: "Top 10 Opportunities", value: json.records.length }
      };

      // console.log(bubble_data)
      // console.log(JSON.stringify(bubble_data, null, '  '))
      //chart.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: bubble_data.data.length} );

      var chart = nv.models.bubbleChart()
          .x(function(d) { return d3.time.format("%Y-%m-%d").parse(d.x) })
          .y(function(d) { return d.y })
          .tooltip( function(key, x, y, e, graph) {
              return '<p>Assigned: <b>' + e.point.assigned_user_name + '</b></p>' +
                     '<p>Amount: <b>$' +  d3.format(',.2d')(e.point.opportunity) + '</b></p>' +
                     '<p>Close Date: <b>' +  d3.time.format('%x')(d3.time.format("%Y-%m-%d").parse(e.point.x)) + '</b></p>' +
                     '<p>Probability: <b>' +  e.point.probability + '%</b></p>' +
                     '<p>Account: <b>' +  e.point.account_name + '</b></p>';
          })
          .showTitle(false)
          .tooltips(true)
          .showLegend(true)
          //.colorData( 'graduated', {c1: '#accfde', c2: '#173b68', l: bubble_data.data.length} )
          .classStep(2)
          .colorData( 'class' )
          //.colorData( 'default' )
          //.colorFill( 'gradient' )
          .colorFill( 'default' )
          .groupBy(function(d){ return d.assigned_user_name; })
          .filterBy(function(d){ return d.probability; })
        ;


      d3.select('#bubble svg')
          .datum(bubble_data)
        .transition().duration(500)
          .call(chart);

      nv.utils.windowResize(chart.update);

      return chart;
    });

  });

// http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities/filter?fields=assigned_user_name%2Cteam_name%2Copportunity_type%2Caccount_name%2Ccampaign_name%2Clead_source%2Ccurrency_name%2Ccurrency_symbol%2Cdate_closed%2Csales_stage%2Csales_status%2Ccommit_stage%2Cassigned_user_id%2Caccount_id%2Ccampaign_id%2Ccurrency_id%2Cname%2Camount%2Cnext_step%2Cprobability%2Ccreated_by_name%2Cmodified_by_name%2Cdate_entered%2Ccreated_by%2Cmodified_user_id&max_num=20&filter%5B0%5D%5B%24owner%5D=
// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities/filter?fields=assigned_user_name%2Cteam_name%2Copportunity_type%2Caccount_name%2Ccampaign_name%2Clead_source%2Ccurrency_name%2Ccurrency_symbol%2Cdate_closed%2Csales_stage%2Csales_status%2Ccommit_stage%2Cassigned_user_id%2Caccount_id%2Ccampaign_id%2Ccurrency_id%2Cname%2Camount%2Cnext_step%2Cprobability%2Ccreated_by_name%2Cmodified_by_name%2Cdate_entered%2Ccreated_by%2Cmodified_user_id&max_num=20&filter%5B0%5D%5B%24owner%5D=';
// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities?fields=name%2Caccount_name%2Camount%2Cassigned_user_name%2Cdate_closed%2Ccurrency_id%2Cbase_rate%2Caccount_id&max_num=10&order_by=amount%3Adesc&my_items=1';

// url = 'http://localhost:8888/builds/sugar7/ent/sugarcrm/rest/v10/Opportunities?fields=name%2Caccount_name%2Camount%2Cassigned_user_name%2Cdate_closed%2Ccurrency_id%2Cbase_rate%2Caccount_id&max_num=10&order_by=amount%3Adesc&my_items=1&list=all&limit=0';
</script>
</body>
</html>


