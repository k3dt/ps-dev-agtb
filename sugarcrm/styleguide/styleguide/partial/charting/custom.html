   <section id="custom">
      <div class="page-header">
        <h2>Custom Charts <small>used for comparing values in a process</small></h2>
      </div>

      <div class="row">
        <div class="span6">
          <h3>Pipeline By Sales Stage</h3>
          <p>This is a new NVD3 funnel chart type created for SugarCRM. <a href="charts/funnelChart.html">Full Screen</a></p>
          <div>
<div id="funnel1" class="thumbnail nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Closed Won Opportunities</h3>
          <p>This is a new NVD3 gauge chart type created for SugarCRM. <a href="charts/gaugeChart.html">Full Screen</a></p>
          <div>
<div id="gauge" class="thumbnail nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="span6">
          <h3>Treemap Chart</h3>
          <p>This is a new NVD3 treemap chart type created for SugarCRM. <a href="charts/treemapChart.html">Full Screen</a></p>
          <div>
<div id="treemap1" class="thumbnail nv-chart nv-treemap">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
          <h3>Opportunities</h3>
          <p>This is a new NVD3 treemap chart type created for SugarCRM. <a href="charts/treemapChart_opportunities.html">Full Screen</a></p>
          <div>
<div id="treemap2" class="thumbnail nv-chart nv-treemap">
  <svg></svg>
</div>
          </div>
        </div>
      </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="span6">
          <h3>Org Chart</h3>
          <p>This is a new NVD3 tree chart type created for SugarCRM. <a href="charts/orgChart.html">Full Screen</a></p>
          <div>
<div id="org" class="thumbnail nv-tree nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
        </div>
        <div class="span6">
          <h3>Bubble Chart</h3>
          <p>This is a new NVD3 tree chart type created for SugarCRM. <a href="charts/bubbleChart.html">Full Screen</a></p>
          <div>
<div id="bubble" class="thumbnail nv-bubble nv-chart">
  <svg></svg>
</div>
          </div>
        </div>
        <div class="span6">
        </div>
      </div>
    </section>

<script src="js/nvd3/data/gauge_data.js"></script>
<script src="js/nvd3/data/funnel_data.js"></script>
<script src="js/nvd3/data/treemap_data.js"></script>
<script src="js/nvd3/data/flare.js"></script>
<script src="js/nvd3/data/tree_data.js"></script>

<script>
  // Funnel Chart
  nv.addGraph(function() {
    var chart = nv.models.funnelChart()
          .showTitle(false)
          .tooltip( function(key, x, y, e, graph) {
              return '<p>Stage: <b>' + key + '</b></p>' +
                     '<p>Amount: <b>$' +  parseInt(y) + 'K</b></p>' +
                     '<p>Percent: <b>' +  x + '%</b></p>'
            });

    chart.yAxis
        .tickFormat(d3.format(',.1f'));

    d3.select('#funnel1 svg')
        .datum(funnel_data)
      .transition().duration(500)
        .call(chart);

    return chart;
  });

  // Gauge Chart
  nv.addGraph(function() {
    var gauge = nv.models.gaugeChart()
          .x(function(d) { return d.key })
          .y(function(d) { return d.y })
          .showLabels(true)
          .showTitle(false)
          .colorData( 'default' )
          .colorFill( 'gradient' )
          .ringWidth(50)
          .maxValue(9)
          .transitionMs(4000);

    d3.select("#gauge svg")
        .datum(gauge_data)
      .transition().duration(500)
        .call(gauge);

    return gauge;
  });

  // Treemap flare chart
  nv.addGraph(function() {

    var chart = nv.models.treemapChart()
          .leafClick( function(d) {
              alert('leaf clicked');
          })
          .useClass(true)
          .showTitle(false)
          .tooltips(true)
          .getSize(function(d) { return d.size; })
          .className(function(d,i) {
            var m = chart.groups().indexOf(d.parent.name) % 20;
            return 'nv-fill' + (m>9?'':'0') + m%20;
          })
          //.showControls(false)
          //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: chartData.data.length} )
          //.colorData( 'class' )
          //.colorData( 'default' )
          //.colorFill( 'gradient' )
          //.colorFill( 'default' )
      ;

    d3.select('#treemap1 svg')
        .datum(flare_data)
      .transition().duration(500)
        .call(chart);

    return chart;
  });

  // Tree org chart
  nv.addGraph(function() {

    var nodeRenderer = function(d){
      return '<img src="img/'+ d.image +'" class="rep-avatar" width="32" height="32"><div class="rep-name">'+ d.name +'</div><div class="rep-title">'+ d.title + '</div>';
    }

    var chart = nv.models.tree()
          .duration(300)
          .nodeSize({ 'width': 124, 'height': 56 })
          .nodeRenderer(nodeRenderer)
          .zoomExtents({ 'min': 0.25, 'max': 4 });

    d3.select("#org svg")
        .datum(tree_data)
      .transition().duration(700)
        .call(chart);

    nv.utils.windowResize(function(){ chart.resize(); });

    return chart;
  });

  // Bubble chart
  nv.addGraph(function() {
    var format = d3.time.format("%Y-%m-%d");

    var chart = nv.models.bubbleChart()
          .x(function(d) { return format.parse(d.x) })
          .y(function(d) { return d.y })
          .tooltip( function(key, x, y, e, graph) {
              return '<p>Industry: <b>' + key + '</b></p>' +
                     '<p>Amount: <b>$' +  d3.format(',.02d')(e.point.opportunity) + '</b></p>' +
                     '<p>Date: <b>' +  x + '</b></p>'
            })
          .showTitle(true)
          .tooltips(true)
          .showLegend(true)
        ;

    d3.json("js/nvd3/data/top10_opportunities.json", function(json) {
      var bubble_data = json;

      //chart.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: bubble_data.data.length} );

      d3.select('#bubble svg')
          .datum(bubble_data)
        .transition().duration(500)
          .call(chart);
    });

    nv.utils.windowResize(chart.update);

    return chart;
  });


  // Treemap opportunities chart
  nv.addGraph(function() {

    var root = {
        name: "Opportunities",
        children: [],
        x: 0,
        y: 0,
        dx: parseInt($('#treemap2 svg').width(), 10),
        dy: parseInt($('#treemap2 svg').height(), 10),
        depth: 0
    };

    root.children = parseData( treemap_data.records );

    var chart = nv.models.treemapChart()
          .leafClick( function(d) {
              // var model = app.data.createBean(self.module);
              // model.set("id", d.id);
              // model.fetch();
              // app.navigate(self.context, model);
              alert('leaf clicked');
          })
          .useClass(true)
          .showTitle(false)
          .tooltips(true)
          .tooltipContent( function(point) {
              var rep = (point.assigned_user_name) ? point.assigned_user_name : (point.className) ? point.parent.name : point.name,
                  stage = (point.sales_stage) ? point.sales_stage : (point.className) ? point.name : null,
                  account = (point.account_name) ? point.account_name : null;
              var tt = '<h4>Amount: <b>$' + d3.format(',.2s')(point.value) + '</b></h4>' +
                '<p>Sales Rep: <b>' + rep + '</b></p>';
              if (stage) tt += '<p>Stage: <b>' +  stage + '</b></p>';
              if (account) tt += '<p>Account: <b>' +  account + '</b></p>';
              return tt;
          })
          .getSize(function(d) { return d.value; })
          .className(function(d) { return d.className; })
          //.showControls(false)
          //.colorData( 'graduated', {c1: '#e8e2ca', c2: '#3e6c0a', l: chartData.data.length} )
          //.colorData( 'class' )
          //.colorData( 'default' )
          //.colorFill( 'gradient' )
          //.colorFill( 'default' )
        ;

    d3.select('#treemap2 svg')
        .datum(root)
      .transition().duration(500)
        .call(chart);

    function parseData(data) {
      var today = new Date();
          today.setUTCHours(0,0,0,0);

      var day_ms = 1000*60*60*24
        , d1 = new Date(today.getTime() + 31*day_ms)
        , root = {
              children: []
          };

      data = data.filter(function(model) {
          // Filter for 30 days from now.
          var d2 = new Date(model.date_closed || "1970-01-01");
          return (d2-d1)/day_ms <= 30;
      }).map(function(d){
          // Include properties to be included in leaves
          return {
            assigned_user_name: d.assigned_user_name,
            sales_stage: d.sales_stage,
            name: d.name,
            amount_usdollar: d.amount_usdollar
          };
      });

      data = _.groupBy(data, function(m) {
          return m.assigned_user_name;
      });

      _.each(data, function(value, key, list) {
          list[key] = _.groupBy(value, function(m) {
              return m.sales_stage;
          });
      });

      _.each(data, function(value1, key1) {
          var child = [];
          _.each(value1, function(value2, key2) {
              _.each(value2, function(record) {
                  record.className = 'stage_'+record.sales_stage.toLowerCase().replace(' ', '');
                  record.value = parseInt(record.amount_usdollar, 10);
              });
              child.push({
                  name: key2,
                  className: 'stage_'+key2.toLowerCase().replace(' ', ''),
                  children: value2
              });
          });

          root.children.push({
              name: key1,
              children: child
          });
      });

      function accumulate(d) {
          if(d.children) {
              return d.value = d.children.reduce(function(p, v) { return p + accumulate(v); }, 0);
          }
          return d.value;
      }

      accumulate(root);

      return root.children;
    }

    return chart;
  });
</script>
